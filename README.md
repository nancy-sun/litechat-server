# litechat-server

![Frame](https://user-images.githubusercontent.com/99620863/177199682-a2091c25-cc69-46b7-a056-5a2528b1dec7.svg)      
  
Deployed at https://litechat-server.herokuapp.com/  
Client site repo: https://github.com/nancy-sun/litechat  
Application deployed at: https://lite-chat-react.herokuapp.com/  

## Description

This is the server repo for [lite chat](https://github.com/nancy-sun/litechat). LiteChat is an anonymous n-to-n real-time chat application for web browsers with websocket TCP connection for message chat, and webRTC UCP connections for voice chat.  
  
## Installation  
Clone source code locally:
```
$ git clone https://github.com/nancy-sun/litechat-server
```
Install dependencies:
```
$ npm install
```
Start running:
```
$ npm start
```
Run development:
```
$ npm run dev
```
  
**Environment variable example for `.env` file:**  
- `PORT = 5050`
- `CLIENT_URL = http://localhost:3000` *(react default PORT 3000)*  
- `SERVER_URL = http://localhost:5050` *(should be based on the PORT server is running on)*  
- `DATABASE_URI` is the URI provided by mongoDB when creating database
  

*Note that `DATABASE_URI` should never be on remote repo as it contains username and password info. Database should only be accessed by client site application and in development environment for basic user data protection. This could be achieved by setting up `cors` origin configurations.*
  
## Tech Stack
* Node.js
* MongoDB - Mongoose
* Socket.io
* [cors](https://www.npmjs.com/package/cors)
  
## API Documentation   
  
### Overview  
- local host PORT: 5050
- local host API URL: http://localhost:5050
- API live URL: https://lite-chat-react.herokuapp.com/  
- **Note** that this is only for demo purpose, data should not be publically accessible. Cors and environment variables are configured to only allow client application users to access data and in local development environment. This is for the purpose of basic data protection. However, database security is not guarenteed. Ideally, more advanced protection should be implemented for the database including but not limited to authentication and authorization, encryption, etc.  


### API Routes  
  
#### GET /room
- to get an array of room objects
- `_id` generated by mongoDB, `userID` is assigned with `socket.id`
- response body example
    ```json
    [
        {
            "_id": "62c27a07af3b142839ebbdf4",
            "users": [
                {
                    "username": "pikachu",
                    "userID": "123456789",
                    "_id": "62c27cecda4e2a269cf3e40c"
                }
            ],
            "voiceUsers": [],
            "messageHistory": [],
            "__v": 0
        },
        {
            "_id": "62c27d31da4e2a269cf3e40f",
            "users": [
                {
                    "username": "ditto",
                    "userID": "987654321",
                    "_id": "62c27d42da4e2a269cf3e411"
                }
            ],
            "voiceUsers": [],
            "messageHistory": [],
            "__v": 0
        }
    ]
    ```
    
#### POST /room
- to create a new room object and add to the rooms array
- request body - n/a
- response body example:
    ```json
    {
        "users": [],
        "voiceUsers": [],
        "messageHistory": [],
        "_id": "62c27dccda4e2a269cf3e414",
        "__v": 0
    }
    ```
    
#### GET /room/:roomID
- get a single room from rooms array by `roomID`
- response body example:
    ```json
    {
        "_id": "62c27a07af3b142839ebbdf4",
        "users": [
            {
                "username": "pikachu",
                "userID": "123456789",
                "_id": "62c27cecda4e2a269cf3e40c"
            }
        ],
        "voiceUsers": [],
        "messageHistory": [],
        "__v": 0
    }
    ```
    
#### DELETE /room/:roomID
- remove a room object from rooms array by `roomID`
- response body example: *(the updated rooms array)*
    ```json
    [
        {
            "_id": "62c27a07af3b142839ebbdf4",
            "users": [
                {
                    "username": "pikachu",
                    "userID": "123456789",
                    "_id": "62c27cecda4e2a269cf3e40c"
                }
            ],
            "voiceUsers": [],
            "messageHistory": [],
            "__v": 0
        }
    ]
    ```
    
#### POST /room/:roomID
- post new message to a room object by `roomID`
- request body eaxmple:
    ```json
    {                
        "message": "test message",
        "username": "pikachu",
        "time": "20:18"
    }
    ```
- response body exampe *(updated room object)*
    ```json
    {
        "_id": "62c27a07af3b142839ebbdf4",
        "users": [
            {
                "username": "pikachu",
                "userID": "123456789",
                "_id": "62c27cecda4e2a269cf3e40c"
            }
        ],
        "voiceUsers": [],
        "messageHistory": [
            {
                "message": "test message",
                "username": "pikachu",
                "time": "20:18",
                "_id": "62c27e77da4e2a269cf3e41f"
            }
        ],
        "__v": 0
    }
    ```
    
#### POST /room/:roomID/user
- add a new user to the users array in a room Object by `roomID` when user joins room
- request body example
    ```json
    {
        "username": "ditto",
        "userID": "987654321"
    }
    ```
- response body example *(updated room object)*
    ```json
    {
        "_id": "62c27a07af3b142839ebbdf4",
        "users": [
            {
                "username": "pikachu",
                "userID": "123456789",
                "_id": "62c27cecda4e2a269cf3e40c"
            },
            {
                "username": "ditto",
                "userID": "987654321",
                "_id": "62c27f41da4e2a269cf3e424"
            }
        ],
        "voiceUsers": [],
        "messageHistory": [
            {
                "message": "test message",
                "username": "pikachu",
                "time": "20:18",
                "_id": "62c27e77da4e2a269cf3e41f"
            }
        ],
        "__v": 0
    }
    ```
    
#### PUT /room/:roomID/user
- add a new user to the voiceUsers array in a room Object by `roomID` when user joins voice chat in a room
- request body example
    ```json
    {
        "username": "ditto",
        "userID": "987654321"
    }
    ```
- response body example: *(updated room object)*
    ```json
    {
        "_id": "62c27a07af3b142839ebbdf4",
        "users": [
            {
                "username": "pikachu",
                "userID": "123456789",
                "_id": "62c27cecda4e2a269cf3e40c"
            },
            {
                "username": "ditto",
                "userID": "987654321",
                "_id": "62c27f41da4e2a269cf3e424"
            }
        ],
        "voiceUsers": [
            {
                "username": "ditto",
                "userID": "987654321",
                "_id": "62c27f76da4e2a269cf3e426"
            }
        ],
        "messageHistory": [
            {
                "message": "test message",
                "username": "pikachu",
                "time": "20:18",
                "_id": "62c27e77da4e2a269cf3e41f"
            }
        ],
        "__v": 0
    }
    ```
    
#### DELETE /room/:roomID/:userID
- remove a user from the users array and the voiceUsers array in a room object by `roomID` and `userID` when user leaves
- response body example: *(updated room object)*
    ```json
    {
        "_id": "62c27a07af3b142839ebbdf4",
        "users": [
            {
                "username": "pikachu",
                "userID": "1",
                "_id": "62c27cecda4e2a269cf3e40c"
            }
        ],
        "voiceUsers": [],
        "messageHistory": [
            {
                "message": "test message",
                "username": "pikachu",
                "time": "20:18",
                "_id": "62c27e77da4e2a269cf3e41f"
            }
        ],
        "__v": 0
    }
    ```
    
#### DELETE /room/:roomID/:msgID
- delete a message from messageHistory array of a room object by `roomID` and `msgID`
- response body example: *(the updated room object)*

```json
{
    "_id": "62c27a07af3b142839ebbdf4",
    "users": [
        {
            "username": "pikachu",
            "userID": "1",
            "_id": "62c27cecda4e2a269cf3e40c"
        }
    ],
    "voiceUsers": [],
    "messageHistory": [],
    "__v": 0
}
```
    
#### Websocket routes examples

**basic events:** 
- `io.on("connection", callback(socket))` gets the connecting user's socket  
- `socket.on("disconnect", callback()` handles socket disconnection evnet.  (tab closing event by default, could mannually disconnect user with `socket.disconnect()` at client site)  

**room event examples:**  
- `socket.on("join", (data, callback())`
- `socket.emit("sendMsg", callback(data));`  

**rtc handshake examples:**  
- `socket.on("joinVoice", callback(data))`
- `socket.on("sendSgn", callback(data))`
- `socket.on("returnSgn", callback(data))`
  
  

## Future Discussions
- (TBD) build a `STUN` server  
  
  
## Application prototype  
*details at [litechat](https://github.com/nancy-sun/litechat)*  
![litechatPrototype](https://user-images.githubusercontent.com/99620863/181904643-b83ac8fb-8bd6-4436-af5f-9b2577b38fc2.svg)

## Author  
[@Nancy](https://github.com/nancy-sun)   
